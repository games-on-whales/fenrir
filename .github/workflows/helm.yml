name: Build and Push Helm Chart

on:
  push:
    branches: [main]
  release:
    # mirror the docker workflow trigger; include common release events
    types: [released, published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  packages: write
  contents: read

jobs:
  build_and_push_chart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Read chart version
        id: get_version
        run: |
          set -euo pipefail
          chart_path="charts/direwolf"
          if [ ! -f "$chart_path/Chart.yaml" ]; then
            echo "Chart.yaml not found at $chart_path" >&2
            exit 1
          fi
          # read the 'version:' field from Chart.yaml (simple YAML -> space-separated)
          version=$(grep '^version:' "$chart_path/Chart.yaml" | head -n1 | awk '{print $2}')
          if [ -z "$version" ]; then
            echo "Could not determine chart version" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Copy CRDs into chart
        run: |
          # Ensure the chart CRDs directory exists and copy repository CRDs there. This makes them part of the packaged chart.
          mkdir -p charts/direwolf/crds
          if compgen -G "crds/*.yaml" > /dev/null; then
            cp crds/*.yaml charts/direwolf/crds/
          else
            echo "No CRDs found in repository crds/ - continuing"
          fi

      - name: Package Helm chart
        run: |
          mkdir -p packaged
          helm dependency update charts/direwolf
          helm package charts/direwolf -d packaged
          ls -lah packaged

      - name: Login to GHCR for Helm OCI
        if: ${{ !github.event.pull_request.head.repo.fork }}
        run: |
          set -euo pipefail
          echo "Logging in to ghcr.io with helm registry login"
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Push packaged chart with Helm (OCI)
        env:
          CHART_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          set -euo pipefail
          chart_file=$(ls packaged/*.tgz | head -n1)
          if [ -z "$chart_file" ]; then
            echo "No packaged chart found" >&2
            exit 1
          fi
          chart_ref="oci://ghcr.io/${{ github.repository_owner }}/charts"
          echo "Pushing $chart_file to $chart_ref"
          helm push "$chart_file" "$chart_ref"

      - name: Verify pushed artifact
        run: |
          chart_ref="oci://ghcr.io/${{ github.repository_owner }}/charts:${{ steps.get_version.outputs.version }}"
          echo "Pushed chart $chart_ref"
